<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2019-08-04 
 | Rendered using BloomReach Forge Maven Skin 3.0.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta name="Date-Revision-yyyymmdd" content="20190804" />
              <meta http-equiv="Content-Language" content="en" />
      <title>Hippo Repository JCR/WebDAV Support &#x2013; Simple WebDAV Advanced - Security Framework Integration</title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-3.0.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-3.0.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  <link rel="icon" type="image/png" href="./images/skin/logo_64.png" sizes="64x64">

  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-3.0.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-3.0.1.min.js"></script>

    </head>
<body class="topBarDisabled">
                        <a href="https://github.com/bloomreach-forge/hippo-jcr-over-webdav">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
         alt="Fork me on GitHub">
  </a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
      <a href="http://www.github.com/bloomreach-forge">
        <img src="./images/skin/logo.png" alt="BloomReach Forge Logo" />
      </a>
    </div>
    <div class="pull-left">              <div id="bannerLeft">    <h1>Hippo Repository JCR/WebDAV Support</h1>
    </div>
              </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
    <div class="links">
      <a href="https://developers.bloomreach.com">developers.bloomreach.com</a>
      <a href="https://www.onehippo.org">onehippo.org</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: 2019-08-04  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li class="nav-header">Main</li>
              <li>  <a href="index.html" title="Welcome">  <span class="none"></span>  Welcome</a>  </li>
        <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="remote-repository.html" title="How to Use Remote Repository">  <span class="none"></span>  How to Use Remote Repository</a>  </li>
        <li>  <a href="cmd-examples.html" title="Command Line Examples">  <span class="none"></span>  Command Line Examples</a>  </li>
                                                    <li>  <a href="simple-webdav-support.html" title="Simple WebDAV Support">  <span class="icon-chevron-down"></span>  Simple WebDAV Support</a>  
    <ul class="nav nav-list">
                  <li>  <a href="example-webfiles-via-webdav.html" title="Example - WebFiles via WebDAV">  <span class="none"></span>  Example - WebFiles via WebDAV</a>  </li>
                        <li class="active">  <a href="#"><span class="none"></span>Advanced - Security Framework Integration</a>
  </li>
              </ul>
  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
                  <li class="nav-header">Autogenerated Docs</li>
                                                                                                                                                                                                                                                    <li>  <a href="project-info.html" title="Project Information">  <span class="icon-chevron-right"></span>  Project Information</a>  </li>
                                          <li>  <a href="project-reports.html" title="Project Reports">  <span class="icon-chevron-right"></span>  Project Reports</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
              <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">  <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />  </a>
          </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    
  

    <div class="section">
<h2><a name="Simple_WebDAV_Advanced_-_Security_Framework_Integration"></a>Simple WebDAV Advanced - Security Framework Integration</h2>
      
<p>
        You can optionally integrate the <tt>SimpleWebdavServlet</tt> with a Web Application Security Framework
        such as Spring Security Framework.
        <tt>SimpleWebdavServlet</tt> allows you to override <tt>#getCredentialsProvider()</tt> method
        which gives a <tt>org.apache.jackrabbit.server.CredentialsProvider</tt> returning a valid <tt>javax.jcr.Credentials</tt> object
        for the WebDAV session and handles the basic authentication payloads by default if necessary.
      </p>
      
<p>
        Therefore, if you set a servlet filter provided by a Web Application Security Framework before the
        <tt>SimpleWebdavServlet</tt>, then it is technically possible to read the authentication information,
        established by the Web Application Security Framework,
        and return a <tt>javax.jcr.Credentials</tt> object from your custom <tt>CredentialsProvider</tt>.
        If <tt>SimpleWebdavServlet</tt> finds a valid <tt>javax.jcr.Credentials</tt> object from your
        custom <tt>CredentialsProvider</tt>, then it won't ask for basic authentication any more.
      </p>
    </div>

    
<div class="section">
<h2><a name="Example_Scenario_with_Spring_Security_Framework"></a>Example Scenario with Spring Security Framework</h2>
      
<div class="alert alert-warning">
        
<p>
          This example is only for explanation purpose, not meant to be used directly in production.
          You should understand more about the underlying Web Application Security Framework and your own
          requirements and architectural concerns.
        </p>
      </div>
      
<p>
        Suppose you configured Spring Security Framework in the web application and so a servlet filter provided
        by the Spring Security Framework handles authentication before <tt>SimpleWebdavServlet</tt>,
        with the following example configuration:
      </p>
      
<div class="brush: xml">
      
<div class="source"><pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans:beans xmlns=&quot;http://www.springframework.org/schema/security&quot;
       xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
                           http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd&quot;&gt;

  &lt;http auto-config=&quot;true&quot;
        use-expressions=&quot;true&quot;
        realm=&quot;Hippo CMS WebDAV&quot;&gt;
    &lt;csrf disabled=&quot;true&quot;/&gt;
    &lt;intercept-url pattern=&quot;/webdav/&quot; access=&quot;permitAll&quot; /&gt;
    &lt;intercept-url pattern=&quot;/webdav/default/webfiles/**&quot; access=&quot;isAuthenticated()&quot; /&gt;
    &lt;intercept-url pattern=&quot;/webdav/default/**&quot; access=&quot;denyAll&quot; /&gt;
    &lt;http-basic /&gt;
  &lt;/http&gt;

  &lt;authentication-manager&gt;
    &lt;authentication-provider ref=&quot;hippoRepositoryAuthenticationProvider&quot; /&gt;
  &lt;/authentication-manager&gt;

  &lt;beans:bean id=&quot;hippoRepositoryAuthenticationProvider&quot;
              class=&quot;com.example.security.spring.HippoRepositoryAuthenticationProvider&quot;&gt;
  &lt;/beans:bean&gt;

&lt;/beans:beans&gt;
      </pre></div>
      </div>
      
<p>
        The <tt>HippoRepositoryAuthenticationProvider</tt> can be implemented like the following (as a simplified version):
      </p>
      
<div class="brush: java">
      
<div class="source"><pre>
public class HippoRepositoryAuthenticationProvider extends AbstractUserDetailsAuthenticationProvider {
    private String repositoryAddress = &quot;vm://&quot;;
    private HippoRepository repository;

    public HippoRepository getRepository() throws RepositoryException {
        if (repository == null) {
            repository = HippoRepositoryFactory.getHippoRepository(repositoryAddress);
        }
        return repo;
    }

    @Override
    protected void additionalAuthenticationChecks(UserDetails userDetails,
            UsernamePasswordAuthenticationToken authentication) throws AuthenticationException {
        // SNIP
    }

    @Override
    protected UserDetails retrieveUser(String username, UsernamePasswordAuthenticationToken authentication)
            throws AuthenticationException {
        Session session = null;
        final String password = authentication.getCredentials().toString();
        final Credentials credentials = new SimpleCredentials(username, password.toCharArray());

        try {
            session = getRepository().login(credentials);
        } catch (LoginException e) {
            throw new BadCredentialsException(e.getMessage());
        } catch (RepositoryException e) {
            throw new ProviderNotFoundException(e.getMessage());
        } finally {
            try {
                session.logout();
            } catch (Exception ignore) {
            }
        }

        final Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;GrantedAuthority&gt;();
        authorities.add(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;));
        return new HippoRepositoryUser(username, password, authorities, credentials);
    }

    public static class HippoRepositoryUser extends User {
        private final Credentials credentials;

        public HippoRepositoryUser(String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities,
                Credentials credentials) {
            super(username, password, authorities);
            this.credentials = credentials;
        }

        public Credentials getCredentials() {
            return credentials;
        }
    }
}
      </pre></div>
      </div>
      
<p>
        By the above configuratin and bean definition, Spring Security Framework will be able to handle authentication
        and possibly it may keep the authentication state for the next servlet chain including <tt>SimpleWebdavServlet</tt>.
      </p>
      
<p>
        Now, let's extend <tt>SimpleWebdavServlet</tt> to use the stored <tt>HippoRepositoryUser</tt> data
        without having to handle basic authentication again:
      </p>
      
<div class="brush: java">
      
<div class="source"><pre>
public class MyCustomSimpleWebdavServlet extends SimpleWebdavServlet {

    @Override
    protected CredentialsProvider getCredentialsProvider() {
        return new CredentialsProvider() {
            @Override
            public Credentials getCredentials(HttpServletRequest request) throws LoginException, ServletException {
                final Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
                if (authentication == null) {
                    throw new LoginException(&quot;Not authenticated.&quot;);
                }
                final Object user = authentication.getPrincipal();
                if (!(user instanceof HippoRepositoryUser)) {
                    throw new LoginException(&quot;Not authenticated.&quot;);
                }

                // Return credentials from Spring Security Framework's AuthenticationProvider
                // without having to proceed with custom basic authentication again.
                return ((HippoRepositoryUser) user).getCredentials();
            }
        };
    }
}
      </pre></div>
      </div>
      
<p>
        Now, you can replace the servlet definition with your custom class extending <tt>SimpleWebdavServlet</tt>
        in the web.xml:
      </p>
      
<div class="brush: xml">
      
<div class="source"><pre>

  &lt;!-- SNIP --&gt;

  &lt;!--
    WebDAV support (DAV 1,2 and DeltaV) to your jackrabbit repository.
  --&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;SimpleWebdavServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.example.webdav.MyCustomSimpleWebdavServlet&lt;/servlet-class&gt;
    &lt;!-- SNIP --&gt;
  &lt;/servlet&gt;

  &lt;!-- SNIP --&gt;

  &lt;!--
    WebDAV support (DAV 1,2 and DeltaV) Servlet Mapping:
  --&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;SimpleWebdavServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/webdav/*&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;

  &lt;!-- SNIP --&gt;

      </pre></div>
      </div>

    </div>

  

    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2019.
  BloomReach Inc. All rights reserved.
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

